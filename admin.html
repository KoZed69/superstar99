<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GL99 - Master Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #eef2f6; font-family: Tahoma, sans-serif; font-size: 12px; }
        .admin-header { background: linear-gradient(to bottom, #3b5998, #1e5396); height: 45px; color: white; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        .sidebar { width: 220px; background: #fff; height: calc(100vh - 45px); float: left; border-right: 1px solid #ccc; }
        .menu-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; }
        .menu-item:hover, .menu-item.active { background: #f0f7ff; color: #1e5396; border-left: 4px solid #1e5396; }
        .content { margin-left: 220px; padding: 20px; height: calc(100vh - 45px); overflow-y: auto; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; width: 400px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #5c87b2; color: white; }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="text-xl font-bold italic text-yellow-400">GL99 MASTER</div>
        <button onclick="location.href='login.html'" class="bg-red-600 text-white px-3 py-1 rounded">Logout</button>
    </div>
    <div class="sidebar">
        <div class="menu-item active" onclick="showSection('users')">Member Management</div>
        <div class="menu-item" onclick="showSection('bets')">Running Bets</div>
    </div>
    <div class="content">
        <div id="sec-users">
            <div class="flex justify-between mb-4">
                <h2 class="text-lg font-bold">Members</h2>
                <button onclick="document.getElementById('modal-add').style.display='flex'" class="bg-green-600 text-white px-3 py-1">Add Member</button>
            </div>
            <div class="bg-white p-2 border"><table><thead><tr><th>User</th><th>Balance</th><th>Action</th></tr></thead><tbody id="user-table"></tbody></table></div>
        </div>
        <div id="sec-bets" style="display:none;">
            <h2 class="text-lg font-bold mb-4">Running Tickets</h2>
            <div id="bet-list"></div>
        </div>
    </div>

    <div id="modal-add" class="modal"><div class="modal-content">
        <h3 class="font-bold mb-4">New Member</h3>
        <input id="new-user" type="text" placeholder="Username" class="w-full border p-2 mb-2">
        <input id="new-pass" type="text" placeholder="Password" class="w-full border p-2 mb-4">
        <button onclick="createUser()" class="w-full bg-blue-600 text-white p-2">Create</button>
        <button onclick="document.getElementById('modal-add').style.display='none'" class="w-full mt-2 text-red-500">Cancel</button>
    </div></div>

    <div id="modal-money" class="modal"><div class="modal-content">
        <h3 class="font-bold mb-2">Manage Balance</h3>
        <p id="target-user" class="font-bold mb-4"></p>
        <input id="amount" type="number" placeholder="Amount" class="w-full border p-2 mb-4">
        <div class="flex gap-2">
            <button onclick="updateBalance('add')" class="flex-1 bg-green-600 text-white p-2">Deposit</button>
            <button onclick="updateBalance('sub')" class="flex-1 bg-red-600 text-white p-2">Withdraw</button>
        </div>
        <button onclick="document.getElementById('modal-money').style.display='none'" class="w-full mt-2 text-red-500">Cancel</button>
    </div></div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
        let selectedUser = '';

        function showSection(id) {
            document.getElementById('sec-users').style.display = 'none';
            document.getElementById('sec-bets').style.display = 'none';
            document.getElementById('sec-'+id).style.display = 'block';
            loadData();
        }

        async function loadData() {
            const res = await fetch(`${API_BASE}/admin/users`);
            const users = await res.json();
            const uTable = document.getElementById('user-table');
            const bList = document.getElementById('bet-list');
            uTable.innerHTML = ''; bList.innerHTML = '';

            users.forEach(u => {
                uTable.innerHTML += `<tr><td>${u.username}</td><td>${u.balance.toLocaleString()}</td><td><button onclick="openMoney('${u.username}')" class="bg-blue-600 text-white px-2 py-1 text-xs">Cash</button></td></tr>`;
                
                if(u.history) u.history.forEach((h, idx) => {
                    if(h.status === 'Running' || h.status === 'Pending') {
                        bList.innerHTML += `<div class="bg-white border p-2 mb-2 flex justify-between"><div><b>${u.username}</b><br>${h.matches.length} Matches</div><div><button onclick="settle('${u.username}',${idx},'Win')" class="bg-green-600 text-white px-2">Win</button> <button onclick="settle('${u.username}',${idx},'Loss')" class="bg-red-600 text-white px-2">Loss</button></div></div>`;
                    }
                });
            });
        }

        function openMoney(u) { selectedUser=u; document.getElementById('target-user').innerText=u; document.getElementById('modal-money').style.display='flex'; }
        
        async function createUser() {
            await fetch(`${API_BASE}/auth/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:document.getElementById('new-user').value, password:document.getElementById('new-pass').value}) });
            document.getElementById('modal-add').style.display='none'; loadData();
        }

        async function updateBalance(type) {
            await fetch(`${API_BASE}/admin/balance`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:selectedUser, amount:parseInt(document.getElementById('amount').value), type}) });
            document.getElementById('modal-money').style.display='none'; loadData();
        }

        async function settle(user, idx, res) {
            if(!confirm("Settle Ticket?")) return;
            await fetch(`${API_BASE}/admin/settle`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:user, betIndex:idx, result:res}) });
            loadData();
        }
        loadData();
    </script>
</body>
</html>
